<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ€é¡µé¢-è®¿é—®é‡ç»Ÿè®¡ï¼ˆæ— é‰´æƒç›´è¿ç‰ˆï¼‰</title>
    <!-- åŒCDNå…œåº•ï¼ŒSDK100%åŠ è½½ï¼Œå›½å†…ç¨³å®š -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>window.supabase || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/@supabase/supabase-js/2.45.1/umd/supabase.min.js"><\/script>')</script>
    <style>
        /* è®¿é—®é‡å±•ç¤ºï¼šåº•éƒ¨å³ä¾§ï¼Œç”µè„‘/æ‰‹æœºé€‚é…ï¼Œä¸é®æŒ¡å†…å®¹ */
        .view-count-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 9999;
            margin: 0;
        }
        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            .view-count-box {
                bottom: 15px;
                right: 15px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        /* é¡µé¢åŸºç¡€æ ·å¼ï¼Œå¯è‡ªè¡Œä¿®æ”¹/åˆ é™¤ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem 80px; /* åº•éƒ¨ç•™ç©ºé¿é®æŒ¡ */
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        h1 { color: #2d3748; margin-bottom: 1rem; font-size: 1.8rem; }
        p { color: #718096; line-height: 1.8; margin-bottom: 0.8rem; }
        /* è°ƒè¯•æ—¥å¿—ï¼šå¯é€‰ä¿ç•™ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼Œå¯ç›´æ¥åˆ é™¤ */
        .debug-log {
            margin-top: 2rem;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>ä½ çš„é™æ€é¡µé¢å†…å®¹</h1>
        <p>éƒ¨ç½²è‡³GitHub Pagesï¼Œè‡ªåŠ¨ç»Ÿè®¡è®¿é—®é‡ï¼Œæ— é‰´æƒç›´è¿Supabase</p>
        <p>30åˆ†é’Ÿå†…åŒä¸€è®¿å®¢ä»…ç»Ÿè®¡1æ¬¡ï¼Œæ•°æ®å®æ—¶åŒæ­¥è‡³æ•°æ®åº“</p>
    </div>

    <!-- è®¿é—®é‡å±•ç¤ºå®¹å™¨ï¼šåº•éƒ¨å³ä¾§ï¼Œè‡ªé€‚åº” -->
    <div class="view-count-box">
        æœ¬ç«™æ€»è®¿é—®é‡ï¼š<span id="viewCount">0</span>
    </div>

    <!-- è°ƒè¯•æ—¥å¿—ï¼šå¯ç›´æ¥åˆ é™¤ï¼Œä¸å½±å“ç»Ÿè®¡åŠŸèƒ½ -->
    <div class="debug-log" id="debugLog">ã€ç»Ÿè®¡æ—¥å¿—ã€‘é¡µé¢åŠ è½½ä¸­ï¼Œåˆå§‹åŒ–Supabase...</div>

    <script>
        // å…¨å±€é…ç½®ï¼šå’Œä½ çš„æµ‹è¯•é¡µä¸€è‡´ï¼Œæ— éœ€ä¿®æ”¹
        const CONFIG = {
            url: 'https://irkrwafgzvnitsalteof.supabase.co',
            anonKey: 'sb_publishable_IP10FVw_R6ZUM1kheAuUQA_IARXx-Ye',
            table: 'page_views',
            pageName: 'index',
            antiSpamTime: 30 * 60 * 1000 // 30åˆ†é’Ÿé˜²åˆ·
        };
        let supabaseClient;
        let isInitOk = false; // ä»…æ ‡è®°åˆå§‹åŒ–æˆåŠŸï¼Œæ— é‰´æƒ
        // é¡µé¢å…ƒç´ 
        const viewCountDom = document.getElementById('viewCount');
        const logDom = document.getElementById('debugLog');

        // æ—¥å¿—å‡½æ•°ï¼šé¡µé¢+æ§åˆ¶å°åŒæ‰“å°
        function log(text) {
            const time = new Date().toLocaleTimeString();
            const logText = `[${time}] ${text}`;
            console.log(logText);
            logDom.textContent += '\n' + logText;
            logDom.scrollTop = logDom.scrollHeight;
        }

        // ğŸ”´ æ— é‰´æƒï¼šä»…åˆå§‹åŒ–Supabaseï¼Œæ— ä»»ä½•authç›¸å…³ä»£ç 
        function initSupabase() {
            try {
                log('=== åˆå§‹åŒ–Supabaseï¼ˆæ— ä»»ä½•é‰´æƒï¼‰ ===');
                if (!window.supabase) throw new Error('SDKåŠ è½½å¤±è´¥ï¼Œæœªæ‰¾åˆ°window.supabase');
                supabaseClient = window.supabase.createClient(CONFIG.url, CONFIG.anonKey);
                isInitOk = true;
                log('âœ… Supabaseåˆå§‹åŒ–æˆåŠŸï¼Œæ— é‰´æƒç›´è¿æ•°æ®åº“');
            } catch (e) {
                isInitOk = false;
                log(`âŒ åˆå§‹åŒ–å¤±è´¥ï¼š${e.message}`);
                viewCountDom.innerText = 'ç»Ÿè®¡å¤±è´¥';
            }
        }

        // é˜²åˆ·åˆ¤æ–­ï¼š30åˆ†é’Ÿå†…åŒä¸€è®¿å®¢ä»…ç»Ÿè®¡1æ¬¡
        function needCount() {
            log('=== æ‰§è¡Œé˜²åˆ·åˆ¤æ–­ ===');
            const key = `pv_${CONFIG.pageName}`;
            const lastTime = localStorage.getItem(key);
            if (!lastTime) {
                log('â„¹ï¸ æœ¬åœ°æ— è®°å½•ï¼Œéœ€ç»Ÿè®¡æœ¬æ¬¡è®¿é—®');
                return true;
            }
            const diff = Date.now() - Number(lastTime);
            if (diff > CONFIG.antiSpamTime) {
                log('â„¹ï¸ è¶…è¿‡30åˆ†é’Ÿï¼Œéœ€ç»Ÿè®¡æœ¬æ¬¡è®¿é—®');
                return true;
            } else {
                log('â„¹ï¸ 30åˆ†é’Ÿå†…å·²ç»Ÿè®¡ï¼Œæœ¬æ¬¡å¿½ç•¥ï¼ˆé˜²åˆ·ï¼‰');
                return false;
            }
        }

        // ğŸŸ¢ è¯»å–è®¿é—®é‡ï¼šå¤ç”¨æµ‹è¯•é¡µæˆåŠŸé€»è¾‘
        async function readCount() {
            if (!isInitOk) return;
            try {
                const { data, error } = await supabaseClient
                    .from(CONFIG.table)
                    .select('view_count')
                    .eq('page_name', CONFIG.pageName)
                    .single();
                if (error) throw error;
                log(`âœ… è¯»å–è®¿é—®é‡æˆåŠŸï¼š${data.view_count}`);
                viewCountDom.innerText = data.view_count;
                return data.view_count;
            } catch (e) {
                log(`âŒ è¯»å–å¤±è´¥ï¼š${e.message}`);
                viewCountDom.innerText = '0';
            }
        }

        // ğŸŸ¢ ç´¯åŠ è®¿é—®é‡ï¼šå¤ç”¨æµ‹è¯•é¡µæˆåŠŸçš„åŸç”ŸSQLé€»è¾‘ï¼ˆæ— rawå‘ï¼‰
        async function addCount() {
            if (!isInitOk) return;
            try {
                log('=== æ‰§è¡Œæ•°æ®åº“ç«¯ç´¯åŠ  ===');
                // åŸç”ŸSQLç´¯åŠ ï¼Œå½»åº•é¿å¼€rawæ–¹æ³•ï¼Œæµ‹è¯•é¡µå·²éªŒè¯æˆåŠŸ
                const { error } = await supabaseClient.sql`
                    UPDATE ${supabaseClient.raw(CONFIG.table)}
                    SET view_count = view_count + 1
                    WHERE page_name = ${CONFIG.pageName}
                `;
                if (error) throw error;
                log('âœ… è®¿é—®é‡ç´¯åŠ æˆåŠŸï¼Œæ•°æ®åº“view_count+1');
                // è®°å½•ç»Ÿè®¡æ—¶é—´åˆ°æœ¬åœ°ï¼Œç”¨äºé˜²åˆ·
                localStorage.setItem(`pv_${CONFIG.pageName}`, Date.now().toString());
            } catch (e) {
                log(`âŒ ç´¯åŠ å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ä¸»é€»è¾‘ï¼šé¡µé¢åŠ è½½è‡ªåŠ¨æ‰§è¡Œï¼Œæ— é‰´æƒ
        async function runStat() {
            // 1. åˆå§‹åŒ–Supabase
            initSupabase();
            if (!isInitOk) return;
            // 2. é˜²åˆ·åˆ¤æ–­ï¼Œç¬¦åˆæ¡ä»¶åˆ™ç´¯åŠ 
            if (needCount()) {
                await addCount();
            }
            // 3. æœ€ç»ˆè¯»å–å¹¶å±•ç¤ºæœ€æ–°è®¿é—®é‡
            await readCount();
            log('=== æœ¬æ¬¡è®¿é—®ç»Ÿè®¡é€»è¾‘æ‰§è¡Œå®Œæˆ ===');
        }

        // é¡µé¢åŠ è½½åæ‰§è¡Œï¼Œæ— ä»»ä½•authç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            runStat();
        });
    </script>
</body>
</html>
