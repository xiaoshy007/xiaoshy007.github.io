<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静态页面-访问量统计（最终可用版）</title>
    <!-- 双CDN兜底：主CDN为你原可用地址，备用CDN国内稳定，彻底解决SDK加载失败 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>window.supabase || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/@supabase/supabase-js/2.45.1/umd/supabase.min.js"><\/script>')</script>
    <style>
        /* 访问量展示：底部右侧、电脑/手机适配、不遮挡内容 */
        .view-count-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 9999;
            margin: 0;
        }
        /* 手机端适配 */
        @media (max-width: 768px) {
            .view-count-box {
                bottom: 15px;
                right: 15px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        /* 页面基础样式，可自行修改/删除 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem 80px; /* 底部留空，避免遮挡 */
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        h1 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }
        p {
            color: #718096;
            line-height: 1.8;
            margin-bottom: 0.8rem;
            font-size: 1rem;
        }
        /* 调试日志区域：直观查看执行流程，可根据需要删除 */
        .debug-log {
            margin-top: 2rem;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>你的静态页面内容</h1>
        <p>部署至GitHub Pages后，自动统计页面访问量，数据实时同步至Supabase</p>
        <p>30分钟内同一访客刷新页面，仅统计1次（防刷机制，基于本地存储）</p>
        <p>所有配置已适配，无需修改，部署即可用</p>
    </div>

    <!-- 访问量展示容器：电脑/手机自适应 -->
    <div class="view-count-box">
        本站总访问量：<span id="viewCount">0</span>
    </div>

    <!-- 调试日志区域：可直接删除，不影响任何统计功能 -->
    <div class="debug-log" id="debugLog">【访问量统计调试日志】页面加载中...</div>

    <script>
        // 全局客户端：沿用你验证过的写法，避免重复声明
        let supabaseClient;
        // 你的专属配置：无需修改，已和Supabase/数据库对齐
        const PAGE_CONFIG = {
            url: 'https://irkrwafgzvnitsalteof.supabase.co',
            anonKey: 'sb_publishable_IP10FVw_R6ZUM1kheAuUQA_IARXx-Ye',
            pageName: 'index', // 与数据库page_views表的page_name一致
            antiSpamTime: 30 * 60 * 1000 // 30分钟防刷时间
        };
        // 页面元素获取
        const viewCountDom = document.getElementById('viewCount');
        const debugLogDom = document.getElementById('debugLog');
        // 鉴权状态标记
        let isAuthSuccess = false;

        // ======================================
        // Supabase初始化：带SDK加载校验，日志更直观
        // ======================================
        function initSupabase() {
            try {
                // 前置校验：SDK是否成功加载
                if (!window.supabase) {
                    log(`❌ Supabase SDK加载失败，未找到全局对象`);
                    viewCountDom.innerText = '加载失败';
                    return false;
                }
                log('=== 开始初始化Supabase ===');
                log(`URL: ${PAGE_CONFIG.url}`);
                log(`公钥: ${PAGE_CONFIG.anonKey.substring(0, 10)}...（已脱敏）`);
                
                supabaseClient = window.supabase.createClient(PAGE_CONFIG.url, PAGE_CONFIG.anonKey);
                log('✅ Supabase初始化成功（与你的配置完全对齐）');
                return true;
            } catch (e) {
                log(`❌ Supabase初始化失败：${e.message}`);
                viewCountDom.innerText = '初始化失败';
                return false;
            }
        }

        // ======================================
        // 日志函数：页面可视化展示，无需打开开发者工具
        // ======================================
        function log(text) {
            const time = new Date().toLocaleTimeString();
            const logText = `[${time}] ${text}`;
            console.log(logText);
            debugLogDom.textContent += '\n' + logText;
            debugLogDom.scrollTop = debugLogDom.scrollHeight;
        }

        // ======================================
        // 匿名鉴权：适配RLS的authenticated角色（已开启匿名登录）
        // ======================================
        async function initAnonymousAuth() {
            try {
                log('=== 开始执行匿名鉴权（RLS策略要求） ===');
                const { error } = await supabaseClient.auth.signInAnonymously();
                if (error) throw error;
                
                isAuthSuccess = true;
                log('✅ 匿名鉴权成功，匹配RLS的authenticated角色');
            } catch (e) {
                log(`❌ 匿名鉴权失败：${e.message}`);
                viewCountDom.innerText = '鉴权失败';
                isAuthSuccess = false;
            }
        }

        // ======================================
        // 防刷判断：30分钟内同一访客仅统计1次
        // ======================================
        function needCountView() {
            log('=== 开始防刷判断 ===');
            const storageKey = `page_view_${PAGE_CONFIG.pageName}`;
            const lastCountTime = localStorage.getItem(storageKey);
            
            if (!lastCountTime) {
                log('ℹ️ 本地无统计记录，需统计本次访问');
                return true;
            }

            const timeDiff = Date.now() - Number(lastCountTime);
            if (timeDiff > PAGE_CONFIG.antiSpamTime) {
                log(`ℹ️ 上次统计已超过30分钟，需统计本次访问`);
                return true;
            } else {
                log(`ℹ️ 30分钟内已统计过，本次忽略（防刷机制生效）`);
                return false;
            }
        }

        // ======================================
        // 数据库端累加访问量：核心统计逻辑
        // ======================================
        async function incrementViewCount() {
            try {
                log('=== 开始累加访问量（数据库端操作） ===');
                const { error } = await supabaseClient
                    .from('page_views') // 你的访问量统计表名
                    .update({ view_count: supabaseClient.raw('view_count + 1') })
                    .eq('page_name', PAGE_CONFIG.pageName); // 匹配当前页面
                
                if (error) throw error;
                log('✅ 访问量累加成功，数据库view_count+1');
                // 记录本次统计时间到本地，用于防刷
                localStorage.setItem(`page_view_${PAGE_CONFIG.pageName}`, Date.now().toString());
            } catch (e) {
                log(`❌ 访问量累加失败：${e.message}`);
            }
        }

        // ======================================
        // 读取访问量并展示到页面：实时获取最新值
        // ======================================
        async function getAndShowViewCount() {
            try {
                log('=== 开始读取数据库最新访问量 ===');
                const { data, error } = await supabaseClient
                    .from('page_views')
                    .select('view_count')
                    .eq('page_name', PAGE_CONFIG.pageName)
                    .single();
                
                if (error) throw error;
                log(`✅ 读取访问量成功，当前总访问量：${data.view_count}`);
                viewCountDom.innerText = data.view_count;
            } catch (e) {
                log(`❌ 读取访问量失败：${e.message}`);
                viewCountDom.innerText = '统计中';
            }
        }

        // ======================================
        // 主统计逻辑：按顺序执行，步骤清晰
        // ======================================
        async function runViewCount() {
            // 1. 初始化Supabase，失败则终止
            if (!initSupabase()) return;
            // 2. 执行匿名鉴权
            await initAnonymousAuth();
            // 3. 鉴权失败则终止
            if (!isAuthSuccess) return;
            // 4. 防刷判断，符合条件则累加
            if (needCountView()) {
                await incrementViewCount();
            }
            // 5. 读取最新访问量并展示（无论是否累加）
            await getAndShowViewCount();
            log('=== 本次访问统计逻辑执行完成 ===');
        }

        // ======================================
        // 事件绑定：沿用你验证过的DOMContentLoaded
        // ======================================
        document.addEventListener('DOMContentLoaded', function() {
            // 页面加载完成后执行统计逻辑
            runViewCount();
            // 监听鉴权状态变化，保证刷新页面仍有效
            supabaseClient?.auth.onAuthStateChange((_, session) => {
                isAuthSuccess = !!session?.user;
                log(`ℹ️ 鉴权状态更新：${isAuthSuccess ? '已认证' : '未认证'}`);
            });
        });
    </script>
</body>
</html>
