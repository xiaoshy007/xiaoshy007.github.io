<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>page_views ç›´è¿è¯»å†™æµ‹è¯•ï¼ˆæ— åŒ¿åé‰´æƒÂ·æœ€ç»ˆä¿®å¤ç‰ˆï¼‰</title>
    <!-- åŒCDNå…œåº•ï¼Œç¡®ä¿SDK100%åŠ è½½ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>window.supabase || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/@supabase/supabase-js/2.45.1/umd/supabase.min.js"><\/script>')</script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: å¾®è½¯é›…é»‘, Consolas; }
        body { padding: 2rem; max-width: 800px; margin: 0 auto; background: #f5f5f5; }
        .container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 1.6rem; color: #2d3748; margin-bottom: 1rem; }
        .tip { color: #dc2626; font-weight: 500; margin: 1rem 0; line-height: 1.6; }
        button { 
            padding: 0.7rem 1.8rem; margin: 0.5rem 0.5rem 1.5rem 0; 
            font-size: 1rem; cursor: pointer; border: none; border-radius: 4px;
            background: #4299e1; color: #fff; transition: background 0.2s;
        }
        button:hover { background: #3182ce; }
        .log { 
            margin-top: 1rem; padding: 1rem; background: #f8f9fa; 
            border-radius: 4px; font-size: 14px; white-space: pre-wrap;
            max-height: 500px; overflow-y: auto; line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>page_views è¡¨ Â· ç›´è¿è¯»å†™æµ‹è¯•ï¼ˆæ— åŒ¿åé‰´æƒï¼‰</h1>
        <div class="tip">âœ… å½»åº•æŠ›å¼ƒrawæ–¹æ³• | ğŸ“Œ è¯»å–/ç´¯åŠ å‡åŸç”ŸSQLå®ç° | ğŸ“ æ—¥å¿—å®æ—¶æ˜¾ç¤ºç»“æœ</div>
        <button id="btnRead">ğŸ“– è¯»å–indexè®¿é—®é‡</button>
        <button id="btnAdd">â• ç´¯åŠ 1æ¬¡è®¿é—®é‡</button>
        <div class="log" id="log">ã€æµ‹è¯•æ—¥å¿—ã€‘é¡µé¢åŠ è½½ä¸­ï¼Œå¼€å§‹åˆå§‹åŒ–Supabase...</div>
    </div>

    <script>
        const CONFIG = {
            url: 'https://irkrwafgzvnitsalteof.supabase.co',
            anonKey: 'sb_publishable_IP10FVw_R6ZUM1kheAuUQA_IARXx-Ye',
            table: 'page_views',
            pageName: 'index'
        };
        let supabaseClient;
        let isInitOk = false;
        const logDom = document.getElementById('log');

        // æ—¥å¿—å‡½æ•°
        function log(text) {
            const time = new Date().toLocaleTimeString();
            const logText = `[${time}] ${text}`;
            console.log(logText);
            logDom.textContent += '\n' + logText;
            logDom.scrollTop = logDom.scrollHeight;
        }
        function clearLog() { logDom.textContent = ''; }

        // åˆå§‹åŒ–Supabaseï¼ˆæ— é‰´æƒï¼‰
        function initSupabase() {
            try {
                log('=== å¼€å§‹åˆå§‹åŒ–Supabaseï¼ˆæ— åŒ¿åé‰´æƒï¼‰ ===');
                if (!window.supabase) throw new Error('SDKåŠ è½½å¤±è´¥ï¼Œæœªæ‰¾åˆ°window.supabase');
                supabaseClient = window.supabase.createClient(CONFIG.url, CONFIG.anonKey);
                isInitOk = true;
                log('âœ… Supabaseåˆå§‹åŒ–æˆåŠŸï¼å¯ç›´æ¥ç‚¹æŒ‰é’®æµ‹è¯•è¯»å†™');
            } catch (e) {
                isInitOk = false;
                log(`âŒ Supabaseåˆå§‹åŒ–å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ç›´æ¥è¯»å–è®¿é—®é‡ï¼ˆåŸç”ŸSELECTé€»è¾‘ï¼Œä¸å˜ï¼‰
        async function readViewCount() {
            clearLog();
            log('=== å¼€å§‹æ‰§è¡Œã€ç›´æ¥è¯»å–ã€‘æ“ä½œ ===');
            if (!isInitOk) { log('âŒ åˆå§‹åŒ–æœªå®Œæˆï¼è¯·ç­‰å¾…é¡µé¢åŠ è½½'); return; }
            
            try {
                const { data, error } = await supabaseClient
                    .from(CONFIG.table)
                    .select('view_count')
                    .eq('page_name', CONFIG.pageName)
                    .single();
                
                if (error) throw new Error(`${error.message} | é”™è¯¯ç ï¼š${error.code || 'æœªçŸ¥'}`);
                log(`âœ… è¯»å–æˆåŠŸï¼page_views.index â†’ è®¿é—®é‡ = ${data.view_count}`);
            } catch (e) {
                log(`âŒ è¯»å–å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæŠ›å¼ƒrawæ–¹æ³•ï¼Œç›´æ¥æ‰§è¡ŒåŸç”ŸUPDATE SQLå®ç°ç´¯åŠ 
        async function addViewCount() {
            clearLog();
            log('=== å¼€å§‹æ‰§è¡Œã€ç›´æ¥ç´¯åŠ ã€‘æ“ä½œ ===');
            if (!isInitOk) { log('âŒ åˆå§‹åŒ–æœªå®Œæˆï¼è¯·ç­‰å¾…é¡µé¢åŠ è½½'); return; }
            
            try {
                // å…ˆè¯»å½“å‰å€¼ï¼ˆä»…æ—¥å¿—å±•ç¤ºå‰åå˜åŒ–ï¼Œå¯é€‰ï¼‰
                const { data: oldData, error: readErr } = await supabaseClient
                    .from(CONFIG.table)
                    .select('view_count')
                    .eq('page_name', CONFIG.pageName)
                    .single();
                if (readErr) throw new Error(`ç´¯åŠ å‰è¯»å–å¤±è´¥ï¼š${readErr.message}`);

                // âœ… ç›´æ¥æ‰§è¡ŒåŸç”ŸUPDATE SQLï¼Œå½»åº•é¿å¼€rawæ–¹æ³•
                const { error: updateErr } = await supabaseClient.sql`
                    UPDATE ${supabaseClient.raw(CONFIG.table)} 
                    SET view_count = view_count + 1 
                    WHERE page_name = ${CONFIG.pageName}
                `;
                if (updateErr) throw new Error(`ç´¯åŠ æ“ä½œå¤±è´¥ï¼š${updateErr.message}`);

                // è¯»å–ç´¯åŠ åçš„å€¼
                const { data: newData } = await supabaseClient
                    .from(CONFIG.table)
                    .select('view_count')
                    .eq('page_name', CONFIG.pageName)
                    .single();

                log(`âœ… ç´¯åŠ æˆåŠŸï¼åŸè®¿é—®é‡ï¼š${oldData.view_count} â†’ æ–°è®¿é—®é‡ï¼š${newData.view_count}`);
            } catch (e) {
                log(`âŒ ç´¯åŠ å¤±è´¥ï¼š${e.message}`);
            }
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–+ç»‘å®šäº‹ä»¶
        window.onload = function() {
            initSupabase();
            document.getElementById('btnRead').onclick = readViewCount;
            document.getElementById('btnAdd').onclick = addViewCount;
        };
    </script>
</body>
</html>
